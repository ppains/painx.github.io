<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Yönetim Paneli - Ultimate UI</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <style>
    :root {
      --bg-dark: #050505;
      --bg-panel: rgba(20, 20, 23, 0.6);
      --primary: #6366f1;
      --primary-glow: rgba(99, 102, 241, 0.6);
      --accent-vip: #f43f5e;
      --accent-gold: #fbbf24;
      --text-main: #ffffff;
      --text-muted: #94a3b8;
      --glass-border: rgba(255, 255, 255, 0.08);
      --glass-shine: rgba(255, 255, 255, 0.03);
      --radius: 20px;
    }

    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

    body {
      margin: 0;
      font-family: 'Outfit', sans-serif;
      background-color: var(--bg-dark);
      background-image: 
        radial-gradient(circle at 10% 20%, rgba(99, 102, 241, 0.15) 0%, transparent 40%),
        radial-gradient(circle at 90% 80%, rgba(244, 63, 94, 0.1) 0%, transparent 40%);
      background-attachment: fixed;
      color: var(--text-main);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

    .page {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px 20px;
      padding-bottom: 100px;
    }

    /* Header & Stats */
    header { margin-bottom: 40px; animation: fadeIn Down 0.8s ease; }
    h1 { 
      font-size: 2.5rem; font-weight: 900; margin: 0 0 20px 0; 
      background: linear-gradient(to right, #fff, #94a3b8); 
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; 
      letter-spacing: -1px;
    }

    .top-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; }
    .stat-card {
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(20px);
      padding: 25px;
      border-radius: var(--radius);
      position: relative;
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .stat-card:hover { transform: translateY(-5px); background: rgba(255, 255, 255, 0.05); border-color: rgba(255, 255, 255, 0.2); box-shadow: 0 10px 30px -10px rgba(0,0,0,0.5); }
    .stat-card::after {
      content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: linear-gradient(45deg, transparent, rgba(255,255,255,0.03), transparent);
      transform: translateX(-100%); transition: 0.5s;
    }
    .stat-card:hover::after { transform: translateX(100%); }
    .stat-card .value { font-size: 2.2rem; font-weight: 800; color: #fff; line-height: 1; margin-top: 10px; }
    .stat-card .label { color: var(--text-muted); font-size: 0.85rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 8px; }
    .stat-card i { color: var(--primary); }

    /* Controls */
    .controls { display: flex; gap: 15px; margin: 30px 0 10px 0; flex-wrap: wrap; }
    .search-wrapper { flex: 1; min-width: 250px; position: relative; }
    .search-wrapper i { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: var(--text-muted); pointer-events: none; transition: 0.3s; }
    .search {
      width: 100%; padding: 16px 16px 16px 50px; border-radius: 16px;
      border: 1px solid var(--glass-border);
      background: rgba(0, 0, 0, 0.3);
      color: #fff; font-size: 1rem; font-family: inherit;
      transition: all 0.3s;
    }
    .search:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15); background: rgba(0,0,0,0.5); }
    .search:focus + i { color: var(--primary); }

    .btn-refresh {
      background: var(--primary); color: white; border: none; padding: 0 25px; border-radius: 16px;
      cursor: pointer; font-weight: 700; display: flex; align-items: center; gap: 10px;
      transition: 0.3s; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
    }
    .btn-refresh:hover { background: #4f46e5; transform: translateY(-2px); box-shadow: 0 8px 25px rgba(99, 102, 241, 0.5); }

    /* Users Grid */
    .users-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 25px;
    }
    .user-card {
      background: rgba(20, 20, 23, 0.6);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius);
      padding: 20px;
      display: flex; align-items: center; gap: 15px;
      cursor: pointer; position: relative; overflow: hidden;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .user-card:hover {
      transform: translateY(-5px) scale(1.02);
      border-color: rgba(99, 102, 241, 0.4);
      box-shadow: 0 15px 40px -10px rgba(0,0,0,0.6), 0 0 20px rgba(99, 102, 241, 0.1);
    }
    .user-card.banned-user { border-color: rgba(239, 68, 68, 0.4); opacity: 0.7; filter: grayscale(0.8); }
    
    /* Avatar Styling */
    .avatar-sm {
      width: 60px; height: 60px; border-radius: 18px;
      background: linear-gradient(135deg, #1e293b, #0f172a);
      display: flex; align-items: center; justify-content: center;
      font-weight: 800; color: #fff; font-size: 1.2rem;
      border: 2px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
      flex-shrink: 0; position: relative;
    }
    .avatar-sm img { width: 100%; height: 100%; object-fit: cover; border-radius: 16px; }

    .user-info { flex: 1; min-width: 0; }
    .user-name { font-weight: 700; font-size: 1.1rem; color: #f1f5f9; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .user-meta { font-size: 0.8rem; color: var(--text-muted); display: flex; flex-wrap: wrap; align-items: center; gap: 8px; }

    /* Tags */
    .tag {
      padding: 4px 10px; border-radius: 8px; font-size: 0.7rem; font-weight: 700;
      text-transform: uppercase; letter-spacing: 0.5px; display: inline-flex; align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2); backdrop-filter: blur(4px);
    }
    .tag-default { background: rgba(255, 255, 255, 0.1); color: #cbd5e1; border: 1px solid rgba(255, 255, 255, 0.05); }

    /* RGB & Effects */
    .rainbow-text-name {
      background: linear-gradient(to right, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3);
      -webkit-background-clip: text; background-clip: text; color: transparent;
      animation: rainbowMove 4s linear infinite;
      font-weight: 900; filter: drop-shadow(0 0 5px rgba(255,255,255,0.2));
    }
    @keyframes rainbowMove { 0% { background-position: 0% 50%; } 100% { background-position: 200% 50%; } }
    @keyframes rainbowGlow { 0% { filter: hue-rotate(0deg); box-shadow: 0 0 15px rgba(255,0,102,0.4); } 50% { filter: hue-rotate(180deg); box-shadow: 0 0 25px rgba(0,212,255,0.6); } 100% { filter: hue-rotate(360deg); box-shadow: 0 0 15px rgba(255,0,102,0.4); } }
    .glow-rainbow { animation: rainbowGlow 3s linear infinite; border: none !important; }

    /* MODAL (Profile) */
    .overlay {
      position: fixed; inset: 0; background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(15px); z-index: 1000;
      display: none; align-items: center; justify-content: center;
      padding: 20px; opacity: 0; transition: opacity 0.4s ease;
    }
    .overlay.open { display: flex; opacity: 1; }

    .profile-box {
      width: 1000px; max-width: 100%; max-height: 90vh;
      background: linear-gradient(160deg, #0f1115 0%, #18181b 100%);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 0 0 1px rgba(0,0,0,0.5), 0 50px 100px -20px rgba(0,0,0,0.8);
      border-radius: 32px; padding: 40px;
      display: grid; grid-template-columns: 280px 1fr 300px; gap: 40px;
      transform: scale(0.9) translateY(20px); opacity: 0;
      transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      overflow-y: auto; position: relative;
    }
    .overlay.open .profile-box { transform: scale(1) translateY(0); opacity: 1; }

    /* Modal Decor */
    .profile-box::before {
      content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 200px;
      background: linear-gradient(180deg, rgba(99, 102, 241, 0.08) 0%, transparent 100%);
      pointer-events: none; z-index: 0; border-radius: 32px 32px 0 0;
    }

    /* Modal Columns */
    .modal-col-left { display: flex; flex-direction: column; align-items: center; text-align: center; gap: 20px; position: relative; z-index: 1; }
    .modal-col-center { display: flex; flex-direction: column; gap: 25px; position: relative; z-index: 1; }
    .modal-col-right { background: rgba(255, 255, 255, 0.02); border-radius: 24px; padding: 25px; border: 1px solid rgba(255, 255, 255, 0.05); position: relative; z-index: 1; height: fit-content; }

    /* Large Avatar */
    .avatar-large {
      width: 180px; height: 180px; border-radius: 40px;
      background: #1e293b; display: flex; align-items: center; justify-content: center;
      font-size: 3.5rem; color: #fff; font-weight: 800;
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);
      border: 4px solid rgba(255, 255, 255, 0.08);
      overflow: hidden; position: relative;
      transition: transform 0.3s;
    }
    .avatar-large:hover { transform: scale(1.05) rotate(2deg); border-color: var(--primary); }
    .avatar-large img { width: 100%; height: 100%; object-fit: cover; }

    /* Stats Grid inside Modal */
    .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .info-box {
      background: rgba(255, 255, 255, 0.03); padding: 15px 20px; border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.05); transition: 0.2s;
    }
    .info-box:hover { background: rgba(255, 255, 255, 0.06); border-color: rgba(255, 255, 255, 0.1); }
    .info-box h4 { margin: 0 0 5px 0; color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; font-weight: 600; letter-spacing: 1px; }
    .info-box p { margin: 0; font-size: 1.25rem; font-weight: 700; color: #fff; font-family: monospace; }

    /* VIP Overlay */
    #vipAnimationOverlay {
      position: fixed; inset: 0; z-index: 2000; pointer-events: none;
      display: none; background: rgba(0,0,0,0.4);
      animation: vipFadeIn 0.5s forwards;
    }
    #vipAnimationOverlay img {
      width: 100%; height: 100%; object-fit: contain;
      mix-blend-mode: screen; filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.5));
    }
    @keyframes vipFadeIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }

    /* Buttons */
    .btn-report {
      width: 100%; margin-top: 15px; padding: 14px;
      background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3);
      color: #f87171; border-radius: 12px; cursor: pointer;
      font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 10px;
      transition: all 0.2s; font-size: 0.9rem;
    }
    .btn-report:hover { background: rgba(239, 68, 68, 0.2); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(239, 68, 68, 0.2); }
    
    .close-btn {
      background: rgba(255,255,255,0.05); width: 40px; height: 40px; border-radius: 50%;
      border: none; color: #fff; font-size: 1.2rem; cursor: pointer; transition: 0.2s;
      display: flex; align-items: center; justify-content: center;
    }
    .close-btn:hover { background: rgba(255,255,255,0.15); transform: rotate(90deg); }

    /* Mobile Responsive */
    @media (max-width: 900px) {
      .profile-box {
        grid-template-columns: 1fr; gap: 30px; padding: 25px;
        max-height: 85vh; width: 100%; border-radius: 24px 24px 0 0; margin-bottom: 0;
        transform: translateY(100%);
      }
      .overlay { align-items: flex-end; padding: 0; }
      .overlay.open .profile-box { transform: translateY(0); }
      
      .modal-col-left { flex-direction: row; text-align: left; }
      .avatar-large { width: 100px; height: 100px; border-radius: 25px; font-size: 2rem; }
      .avatar-3d-placeholder { display: none; }
      .modal-header { flex-direction: column-reverse; gap: 10px; }
      .close-btn { position: absolute; top: 0; right: 0; }
    }
    
    /* Loading */
    #loading { text-align: center; margin-top: 50px; opacity: 0.5; font-size: 1.2rem; }
  </style>
</head>
<body>

  <div class="page">
    <header>
      <h1>Yönetim Paneli</h1>
      <div class="top-stats">
        <div class="stat-card">
          <div class="label"><i class="fa-solid fa-users"></i> Kullanıcılar</div>
          <div class="value" id="totalUsers">0</div>
        </div>
        <div class="stat-card">
          <div class="label"><i class="fa-solid fa-arrow-pointer"></i> Tıklamalar</div>
          <div class="value" id="totalClicks">0</div>
        </div>
        <div class="stat-card">
          <div class="label"><i class="fa-solid fa-chart-line"></i> Günlük</div>
          <div class="value" id="dailyClicks">0</div>
        </div>
      </div>
    </header>

    <div class="controls">
      <div class="search-wrapper">
        <input id="searchInput" class="search" placeholder="Ara: İsim, ID, Etiket, Klan..." />
        <i class="fa-solid fa-search"></i>
      </div>
      <button id="refreshBtn" class="btn-refresh">
        <i class="fa-solid fa-rotate-right"></i> Yenile
      </button>
    </div>
    
    <div style="text-align:right; margin-top:8px; font-size:0.75rem; color:var(--text-muted); font-family:monospace;" id="lastUpdated"></div>

    <div id="usersGrid" class="users-grid"></div>
    <div id="loading">
      <i class="fa-solid fa-circle-notch fa-spin"></i> Veriler Yükleniyor...
    </div>
  </div>

  <div id="profileOverlay" class="overlay" role="dialog" aria-hidden="true">
    <div class="profile-box">
      
      <div class="modal-col-left">
        <div id="pAvatar" class="avatar-large"></div>
        <div style="flex:1;">
             <div id="pLevelBadge" class="tag tag-default" style="background:#3b82f6; color:white; border:none; box-shadow:0 4px 15px rgba(59,130,246,0.4);">LEVEL 0</div>
             <div id="pClanDisplay" style="margin-top:10px; display:none;">
                <span style="color:#ffd700; font-weight:700; display:flex; align-items:center; gap:6px; font-size:0.9rem;">
                    <i class="fa-solid fa-shield-halved"></i> <span id="pClanName"></span>
                </span>
             </div>
        </div>

        <div class="avatar-3d-placeholder" id="p3d" style="width:100%; height:180px; background:rgba(0,0,0,0.3); border-radius:16px; margin-top:10px; display:flex; flex-direction:column; align-items:center; justify-content:center; color:var(--text-muted); border:1px dashed rgba(255,255,255,0.1);">
          <i class="fa-solid fa-cube fa-2x" style="margin-bottom:10px; opacity:0.5;"></i>
          <span style="font-size:0.8rem">3D MODEL</span>
        </div>
      </div>

      <div class="modal-col-center">
        <div class="modal-header" style="display:flex; justify-content:space-between; align-items:flex-start;">
          <div>
            <div id="pName" class="user-display-name" style="font-size:2.5rem; font-weight:800; line-height:1.1;">Kullanıcı Adı</div>
            <div id="pId" style="font-family:monospace; color:var(--primary); font-size:1rem; margin-top:5px; opacity:0.8;">#ID</div>
            <div id="pTags" style="display:flex; gap:8px; margin-top:15px; flex-wrap:wrap;"></div>
          </div>
          <button id="closeProfileBtnTop" class="close-btn"><i class="fa-solid fa-xmark"></i></button>
        </div>

        <div style="font-size:0.9rem; color:var(--text-muted); display:flex; align-items:center; gap:8px;" id="pCreated"></div>

        <div class="stats-grid">
          <div class="info-box">
            <h4><i class="fa-regular fa-clock"></i> Günlük</h4>
            <p id="pDailyClicks">0</p>
          </div>
          <div class="info-box">
            <h4><i class="fa-solid fa-bullseye"></i> Toplam</h4>
            <p id="pTotalClicks">0</p>
          </div>
          <div class="info-box">
            <h4><i class="fa-solid fa-wallet"></i> Bakiye</h4>
            <p style="color:#10b981;" id="pBalance">$0.00</p>
          </div>
          <div class="info-box">
            <h4><i class="fa-solid fa-money-bill-transfer"></i> Çekim</h4>
            <p id="pWithdraw">$0.00</p>
          </div>
        </div>
      </div>

      <div class="modal-col-right">
        <h3 style="margin-top:0; font-size:1rem; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px; margin-bottom:15px; text-transform:uppercase; letter-spacing:1px; color:var(--text-muted);">Profil Detay</h3>
        
        <div style="margin-bottom:20px;">
          <h4 style="color:var(--text-muted); font-size:0.75rem; margin-bottom:8px; text-transform:uppercase;">Roller</h4>
          <p id="pRoles" style="font-size:0.95rem; line-height:1.6; color:#fff;">-</p>
        </div>

        <div style="margin-bottom:20px;">
          <h4 style="color:var(--text-muted); font-size:0.75rem; margin-bottom:8px; text-transform:uppercase;">Hakkında</h4>
          <p id="pAbout" style="font-size:0.9rem; color:#cbd5e1; line-height:1.6; background:rgba(0,0,0,0.2); padding:10px; border-radius:8px;">-</p>
        </div>

        <div style="margin-top:auto; border-top:1px solid rgba(255,255,255,0.1); padding-top:15px;">
            <button id="btnReportUser" class="btn-report">
                <i class="fa-solid fa-triangle-exclamation"></i> Raporla
            </button>
            <p id="reportStatus" style="font-size:0.8rem; margin-top:8px; text-align:center;"></p>
        </div>
      </div>

    </div>
    
    <div id="vipAnimationOverlay">
        <img src="noel.gif" alt="VIP Effect">
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <script>
    // Firebase Config (Aynı Tutuldu)
    const firebaseConfig = {
      apiKey: "AIzaSyBlirRiiNPpdqmTAmq6DsSq8mCUlgBHgVc",
      authDomain: "lilemir-new.firebaseapp.com",
      projectId: "lilemir-new",
      storageBucket: "lilemir-new.firebasestorage.app",
      messagingSenderId: "339863121380",
      appId: "1:339863121380:web:123195552e821b085e6bf1"
    };

    const app = (firebase.apps && firebase.apps.length) ? firebase.app() : firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const usersGrid = document.getElementById('usersGrid');
    const loadingEl = document.getElementById('loading');
    const searchInput = document.getElementById('searchInput');
    const refreshBtn = document.getElementById('refreshBtn');

    const overlay = document.getElementById('profileOverlay');
    const vipOverlay = document.getElementById('vipAnimationOverlay');
    const btnReportUser = document.getElementById('btnReportUser');
    const reportStatus = document.getElementById('reportStatus');
    
    const totalUsersEl = document.getElementById('totalUsers');
    const totalClicksEl = document.getElementById('totalClicks');
    const dailyClicksEl = document.getElementById('dailyClicks');
    const lastUpdatedEl = document.getElementById('lastUpdated');

    let usersCache = [];
    let collectionUnsub = null;
    let userDocUnsub = null;
    let usedCollection = 'users';
    let currentUserInModal = null;

    // role renk haritası (aynı market ile)
    const ROLE_MAP = {
      'vip-': { label: 'VIP-', color: '#3b82f6', contrast: '#fff', multiplier: 1.25, withdrawBonusPercent: 10 },
      'vip+': { label: 'VIP+', color: '#ef4444', contrast: '#fff', multiplier: 1.5, withdrawBonusPercent: 20 },
      'mvp-': { label: 'MVP-', color: '#fbbf24', contrast: '#000', multiplier: 1.75, withdrawBonusPercent: 30 },
      'mvp+': { label: 'MVP+', color: 'rainbow', contrast: '#000', perClickDollar: 1.00, withdrawBonusPercent: 50, priorityWithdraw: true }
    };

    function hexToRgba(hex, a=1){
      if(!hex || hex === 'rainbow') return `rgba(0,0,0,${a})`;
      const c = hex.replace('#','');
      const r = parseInt(c.substr(0,2),16);
      const g = parseInt(c.substr(2,2),16);
      const b = parseInt(c.substr(4,2),16);
      return `rgba(${r},${g},${b},${a})`;
    }
    function getContrastColor(hex){
      if(!hex || hex === 'rainbow') return '#000';
      const c = hex.replace('#','');
      const r = parseInt(c.substr(0,2),16);
      const g = parseInt(c.substr(2,2),16);
      const b = parseInt(c.substr(4,2),16);
      const yiq = (r*299 + g*587 + b*114)/1000;
      return yiq >= 128 ? '#000' : '#fff';
    }
    function money(v){ return '$' + Number(v||0).toLocaleString('en-US', {minimumFractionDigits:2}); }
    function formatDate(ts){ if(!ts) return '-'; try{ if(ts.toDate) ts = ts.toDate(); const d=new Date(ts); return d.toLocaleDateString('tr-TR',{day:'numeric',month:'long',year:'numeric'}); }catch(e){return '-';} }

    function isRainbowName(user){
        if(!user) return false;
        const name = (user.displayName || user.username || '').toLowerCase();
        if(name.includes('rgb') || user.nameColor === 'rainbow' || user.isRainbowName) return true;
        return false;
    }

    async function detectAndSubscribe(){
      loadingEl.style.display = 'block';
      const candidates = ['users','members','profiles','accounts'];
      for(const col of candidates){
        try{
          const snap = await db.collection(col).limit(1).get();
          if(!snap.empty){ usedCollection = col; subscribeToCollection(col); return; }
        }catch(e){ console.log(e); }
      }
      subscribeToCollection('users');
    }

    function subscribeToCollection(colName){
      if(collectionUnsub) collectionUnsub();
      collectionUnsub = db.collection(colName).onSnapshot(snap=>{
        usersCache = [];
        snap.forEach(doc => usersCache.push({ id: doc.id, ...doc.data() }));
        renderUsers(usersCache);
        computeStats(usersCache);
        loadingEl.style.display = 'none';
        lastUpdatedEl.textContent = 'Son güncelleme: ' + new Date().toLocaleTimeString('tr-TR');
      }, err=>{
        loadingEl.innerHTML = '<span style="color:red">Bağlantı Hatası: '+err.message+'</span>';
      });
    }

    function computeStats(list){
      let totC=0, dayC=0;
      list.forEach(u=>{ totC += Number(u.totalClicks||u.total_clicks||u.clicks||0); dayC += Number(u.dailyClicks||u.daily_clicks||0); });
      totalUsersEl.textContent = list.length;
      totalClicksEl.textContent = totC.toLocaleString('tr-TR');
      dailyClicksEl.textContent = dayC.toLocaleString('tr-TR');
    }

    function encodeHTML(s){ return escapeHtml(s); }
    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"'`=\/]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','=':'&#x3D;','`':'&#x60;'}[c])); }

    function createCard(user){
      const card = document.createElement('div');
      card.className = 'user-card';
      
      if(user.banned) {
          card.classList.add('banned-user');
      }

      let avatarHtml = '';
      if(user.avatarUrl){ avatarHtml = `<img src="${user.avatarUrl}" alt="u">`; }
      else { avatarHtml = (user.displayName||user.username||'U').substring(0,2).toUpperCase(); }

      // build role tag if role exists (öncelik)
      let roleTagHtml = '';
      const role = (user.role || '').toLowerCase();
      if(role && ROLE_MAP[role]){
        const cfg = ROLE_MAP[role];
        if(cfg.color === 'rainbow'){
          roleTagHtml = `<span class="tag" style="background:linear-gradient(90deg,#ff004c,#ffd400,#00ff6a,#00d4ff,#7c3aed); color:#000; animation: rainbowGlow 2.8s linear infinite; margin-right:6px;">${encodeHTML(cfg.label)}</span>`;
        } else {
          roleTagHtml = `<span class="tag" style="background:${cfg.color}; color:${cfg.contrast || getContrastColor(cfg.color)}; box-shadow:0 0 10px ${hexToRgba(cfg.color,0.4)}; margin-right:6px;">${encodeHTML(cfg.label)}</span>`;
        }
      }

      const tagsArr = user.tagObjects || user.tags || user.profilEtiketleri || [];
      let tagsHtml = '';
      if(Array.isArray(tagsArr) && tagsArr.length){
        tagsArr.slice(0,3).forEach(t=>{
          let name='', color=null, rainbow=false;
          if(typeof t === 'string'){ name = t; }
          else if(t && t.name){ name = t.name; if(t.color === 'rainbow') rainbow = true; else color = t.color || null; }
          if(!name) return;
          if(rainbow){
            tagsHtml += `<span class="tag" style="background:linear-gradient(90deg,#ff004c,#ffd400,#00ff6a,#00d4ff,#7c3aed); color:#000; animation: rainbowGlow 2.8s linear infinite; margin-right:6px;">${encodeHTML(name)}</span>`;
          } else if(color){
            const contrast = getContrastColor(color);
            tagsHtml += `<span class="tag" style="background:${color}; color:${contrast}; box-shadow:0 0 10px ${hexToRgba(color,0.4)}; margin-right:6px;">${encodeHTML(name)}</span>`;
          } else {
            tagsHtml += `<span class="tag tag-default" style="margin-right:6px;">${encodeHTML(String(name).toUpperCase())}</span>`;
          }
        });
      }

      let nameClass = "user-name";
      if(isRainbowName(user)) nameClass += " rainbow-text-name";

      card.innerHTML += `
        <div class="avatar-sm">${avatarHtml}</div>
        <div class="user-info">
          <div class="${nameClass}">${escapeHtml(user.displayName || user.username || 'No Name')}</div>
          <div class="user-meta">
            ${user.clan ? `<span style="color:#ffd700;"><i class="fa-solid fa-shield-halved"></i> ${escapeHtml(user.clan)}</span>` : ''}
            <span>#${(user.uid || user.id || '').substring(0,5)}</span>
          </div>
          <div style="margin-top:8px;">${roleTagHtml}${tagsHtml}</div>
        </div>
      `;
      card.onclick = ()=> openProfileRealtime(user);
      return card;
    }
    
    function renderUsers(list){
      usersGrid.innerHTML = '';
      list.forEach(u=> usersGrid.appendChild(createCard(u)));
    }

    function fillModal(data){
      currentUserInModal = data;
      const pName = document.getElementById('pName');
      const pId = document.getElementById('pId');
      const pCreated = document.getElementById('pCreated');
      const pTags = document.getElementById('pTags');
      const pAvatar = document.getElementById('pAvatar');
      const pLevelBadge = document.getElementById('pLevelBadge');
      const pClanDisplay = document.getElementById('pClanDisplay');
      const pClanName = document.getElementById('pClanName');
      

      pName.textContent = data.displayName || data.username || 'İsimsiz';
      
      if(isRainbowName(data)){
          pName.classList.add('rainbow-text-name');
      } else {
          pName.classList.remove('rainbow-text-name');
      }

      pId.textContent = 'ID: ' + (data.uid || data.id || '---');
      pCreated.innerHTML = '<i class="fa-regular fa-calendar"></i> Katılım: ' + formatDate(data.createdAt || data.created);

      if(data.clan || data.clanName) {
          pClanDisplay.style.display = 'block';
          pClanName.textContent = data.clan || data.clanName;
      } else {
          pClanDisplay.style.display = 'none';
      }

      document.getElementById('pDailyClicks').textContent = (data.dailyClicks||0).toLocaleString();
      document.getElementById('pTotalClicks').textContent = (data.totalClicks||data.clicks||0).toLocaleString();
      document.getElementById('pBalance').textContent = money(data.balance);
      document.getElementById('pWithdraw').textContent = money(data.withdrawAmount);
      
      // Roller'i biraz daha şık gösterelim (HTML yapısını bozmadan textContent ile)
      const rolesText = (data.roles && data.roles.length) ? data.roles.join(' • ') : (data.role ? data.role : 'Üye');
      document.getElementById('pRoles').textContent = String(rolesText).toUpperCase();
      
      document.getElementById('pAbout').textContent = data.about || data.bio || 'Henüz bir biyografi eklenmemiş.';

      pAvatar.innerHTML = '';
      if(data.avatarUrl){
        const img = document.createElement('img'); img.src = data.avatarUrl; pAvatar.appendChild(img);
      } else {
        pAvatar.textContent = (data.displayName||'U').substring(0,2).toUpperCase();
      }

      // pLevelBadge: gösterilecek rol bilgisi varsa ona göre renk verelim
      const role = (data.role || '').toLowerCase();
      if(role && ROLE_MAP[role]){
        const cfg = ROLE_MAP[role];
        pLevelBadge.textContent = cfg.label;
        if(cfg.color === 'rainbow'){
          pLevelBadge.style.background = 'linear-gradient(90deg,#ff004c,#ffd400,#00ff6a,#00d4ff,#7c3aed)';
          pLevelBadge.style.color = cfg.contrast || '#000';
          pLevelBadge.classList.add('glow-rainbow');
        } else {
          pLevelBadge.style.background = cfg.color;
          pLevelBadge.style.color = cfg.contrast || getContrastColor(cfg.color);
          pLevelBadge.classList.remove('glow-rainbow');
        }
      } else {
        pLevelBadge.textContent = data.level || 'LEVEL 1';
        pLevelBadge.style.background = '#3b82f6';
        pLevelBadge.style.color = '#fff';
        pLevelBadge.classList.remove('glow-rainbow');
      }

      pTags.innerHTML = '';
      const tagsArr = data.tagObjects || data.tags || data.profilEtiketleri || [];
      if(Array.isArray(tagsArr) && tagsArr.length){
        tagsArr.forEach(t=>{
          let name='', color=null, rainbow=false, glow=false;
          if(typeof t === 'string'){ name = t; }
          else if(t && t.name){ name = t.name; color = (t.color === 'rainbow' ? 'rainbow' : (t.color || null)); glow = !!t.glow; }
          if(!name) return;
          const span = document.createElement('span');
          span.className = 'tag';
          if(color === 'rainbow'){
            span.style.background = 'linear-gradient(90deg,#ff004c,#ffd400,#00ff6a,#00d4ff,#7c3aed)';
            span.style.color = '#000';
            span.classList.add('glow-rainbow');
          } else if(color){
            span.style.background = color;
            span.style.color = getContrastColor(color);
            span.style.boxShadow = `0 0 15px ${hexToRgba(color,0.5)}`;
          } else {
            span.classList.add('tag-default');
          }
          span.textContent = name;
          pTags.appendChild(span);
        });
      } else {
        const t = document.createElement('span'); t.className='tag tag-default'; t.textContent='Etiket yok'; pTags.appendChild(t);
      }

      const div3d = document.getElementById('p3d');
      if(data.model3dUrl){ div3d.innerHTML = `<iframe src="${data.model3dUrl}" style="width:100%; height:100%; border:0; border-radius:16px;"></iframe>`; }
      else { div3d.innerHTML = `<i class="fa-solid fa-cube fa-2x" style="opacity:0.5; margin-bottom:10px; display:block;"></i> <span style="opacity:0.5">3D Model Yok</span>`; }

      btnReportUser.disabled = false;
      btnReportUser.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> Raporla';
      btnReportUser.style.background = "rgba(239, 68, 68, 0.1)";
      btnReportUser.style.color = "#f87171";
      reportStatus.textContent = '';
      
      if(data.banned){
           btnReportUser.innerHTML = '<i class="fa-solid fa-ban"></i> Yasaklı';
           btnReportUser.disabled = true;
      }
    }

    function openProfileRealtime(user){
      fillModal(user);
      if(userDocUnsub) userDocUnsub();
      userDocUnsub = db.collection(usedCollection).doc(user.id).onSnapshot(doc=>{
        if(doc.exists) fillModal({ id:doc.id, ...doc.data() });
      });
      overlay.classList.add('open');

      const isPrem = user.isPremium || user.premium;
      const roles = (user.roles || []).map(r=>String(r).toLowerCase());
      const isVip = roles.includes('vip') || roles.includes('admin') || roles.includes('kurucu') || (user.role && ['vip-','vip+','mvp-','mvp+'].includes(String(user.role).toLowerCase()));
      if(isPrem || isVip) playVipAnimation();
    }

    function playVipAnimation(){ 
        vipOverlay.style.display='block'; 
        setTimeout(()=>vipOverlay.style.display='none', 3500); 
    }

    btnReportUser.onclick = async () => {
        if(!currentUserInModal) return;
        const reason = prompt("Raporlama Sebebi:", "Uygunsuz Davranış / Hile");
        
        if(reason){
            btnReportUser.disabled = true;
            btnReportUser.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> İşleniyor...';
            
            try {
                await db.collection('reports').add({
                    targetUid: currentUserInModal.id,
                    targetName: currentUserInModal.displayName || currentUserInModal.username || 'Bilinmeyen',
                    reason: reason,
                    status: 'pending', 
                    reportedBy: 'AdminPanel', 
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                await db.collection('users').doc(currentUserInModal.id).update({
                    isReported: true,
                    lastReportReason: reason
                });

                reportStatus.textContent = "Rapor iletildi.";
                reportStatus.style.color = "#10b981";
                btnReportUser.innerHTML = '<i class="fa-solid fa-check"></i> Raporlandı';
                btnReportUser.style.background = "rgba(16, 185, 129, 0.1)";
                btnReportUser.style.color = "#10b981";

            } catch (error) {
                console.error("Rapor hatası:", error);
                reportStatus.textContent = "Hata: " + error.message;
                btnReportUser.disabled = false;
            }
        }
    };

    document.getElementById('closeProfileBtnTop').onclick = ()=>{ overlay.classList.remove('open'); if(userDocUnsub) userDocUnsub(); vipOverlay.style.display='none'; };
    overlay.onclick = (e)=>{ if(e.target === overlay){ overlay.classList.remove('open'); vipOverlay.style.display='none'; } };
    
    searchInput.addEventListener('input', (e)=>{ 
        const q=e.target.value.toLowerCase(); 
        const filtered = usersCache.filter(u=> 
            (u.displayName||'').toLowerCase().includes(q) || 
            (u.id||'').toLowerCase().includes(q) || 
            (u.roles||[]).join(' ').toLowerCase().includes(q) ||
            (u.clan||'').toLowerCase().includes(q) ||
            (u.role||'').toLowerCase().includes(q)
        ); 
        renderUsers(filtered); 
    });
    
    refreshBtn.onclick = () => detectAndSubscribe();

    db.collection('users').onSnapshot(snap=>{
      usersGrid.innerHTML = '';
      const arr = [];
      snap.forEach(doc => arr.push({ id: doc.id, ...doc.data() }));
      if(arr.length === 0){ loadingEl.textContent = 'Kullanıcı bulunamadı.'; return; }
      
      arr.sort((a,b)=> {
          if(a.isReported && !b.isReported) return -1;
          if(!a.isReported && b.isReported) return 1;
          return (a.displayName||'').localeCompare(b.displayName||'');
      });

      arr.forEach(u=> usersGrid.appendChild(createCard(u)));
      loadingEl.style.display = 'none';
    }, err=>{
      console.error(err);
      loadingEl.textContent = 'Bağlantı hatası.';
    });

    detectAndSubscribe();
  </script>
</body>
</html>